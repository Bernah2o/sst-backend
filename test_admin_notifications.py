#!/usr/bin/env python3
"""
Script de prueba para la funcionalidad de administraci√≥n de notificaciones de ex√°menes ocupacionales.

Este script demuestra c√≥mo usar los nuevos endpoints para:
1. Consultar el estado de las notificaciones
2. Enviar notificaciones manuales
3. Suprimir notificaciones
4. Ver estad√≠sticas

Credenciales de prueba:
- Email: admin@sst.com
- Contrase√±a: Admin123!
"""

import requests
import json
from datetime import datetime
from typing import Dict, Any

# Configuraci√≥n
BASE_URL = "http://localhost:8000"  # Ajustar seg√∫n tu configuraci√≥n
ADMIN_EMAIL = "admin@sst.com"
ADMIN_PASSWORD = "Admin123!"

class AdminNotificationsTest:
    def __init__(self):
        self.base_url = BASE_URL
        self.token = None
        self.headers = {"Content-Type": "application/json"}
    
    def authenticate(self) -> bool:
        """Autenticar como administrador"""
        print("üîê Autenticando como administrador...")
        
        login_data = {
            "username": ADMIN_EMAIL,
            "password": ADMIN_PASSWORD
        }
        
        response = requests.post(
            f"{self.base_url}/auth/login",
            data=login_data
        )
        
        if response.status_code == 200:
            data = response.json()
            self.token = data["access_token"]
            self.headers["Authorization"] = f"Bearer {self.token}"
            print("‚úÖ Autenticaci√≥n exitosa")
            return True
        else:
            print(f"‚ùå Error en autenticaci√≥n: {response.status_code} - {response.text}")
            return False
    
    def get_exam_notifications(self, limit: int = 10) -> Dict[str, Any]:
        """Obtener lista de notificaciones de ex√°menes"""
        print(f"\nüìã Obteniendo notificaciones de ex√°menes (l√≠mite: {limit})...")
        
        response = requests.get(
            f"{self.base_url}/admin/notifications/exam-notifications",
            headers=self.headers,
            params={"limit": limit}
        )
        
        if response.status_code == 200:
            data = response.json()
            print(f"‚úÖ Se encontraron {len(data)} trabajadores")
            
            # Mostrar resumen
            status_count = {}
            for worker in data:
                status = worker["exam_status"]
                status_count[status] = status_count.get(status, 0) + 1
            
            print("üìä Resumen por estado:")
            for status, count in status_count.items():
                print(f"   - {status}: {count}")
            
            return data
        else:
            print(f"‚ùå Error obteniendo notificaciones: {response.status_code} - {response.text}")
            return []
    
    def get_statistics(self) -> Dict[str, Any]:
        """Obtener estad√≠sticas de notificaciones"""
        print("\nüìä Obteniendo estad√≠sticas...")
        
        response = requests.get(
            f"{self.base_url}/admin/notifications/statistics",
            headers=self.headers
        )
        
        if response.status_code == 200:
            data = response.json()
            print("‚úÖ Estad√≠sticas obtenidas:")
            print(f"   - Total trabajadores: {data['total_workers']}")
            print(f"   - Sin ex√°menes: {data['workers_without_exams']}")
            print(f"   - Ex√°menes vencidos: {data['workers_with_overdue_exams']}")
            print(f"   - Pr√≥ximos a vencer: {data['workers_with_upcoming_exams']}")
            print(f"   - Confirmaciones hoy: {data['total_acknowledgments_today']}")
            print(f"   - Notificaciones suprimidas: {data['suppressed_notifications']}")
            return data
        else:
            print(f"‚ùå Error obteniendo estad√≠sticas: {response.status_code} - {response.text}")
            return {}
    
    def send_notifications(self, worker_ids: list, notification_type: str = "reminder", force: bool = False) -> Dict[str, Any]:
        """Enviar notificaciones a trabajadores espec√≠ficos"""
        print(f"\nüìß Enviando notificaciones tipo '{notification_type}' a {len(worker_ids)} trabajadores...")
        
        data = {
            "worker_ids": worker_ids,
            "notification_type": notification_type,
            "force_send": force
        }
        
        response = requests.post(
            f"{self.base_url}/admin/notifications/send-notifications",
            headers=self.headers,
            json=data
        )
        
        if response.status_code == 200:
            result = response.json()
            print("‚úÖ Resultado del env√≠o:")
            print(f"   - Total solicitados: {result['total_requested']}")
            print(f"   - Enviados: {result['emails_sent']}")
            print(f"   - Fallidos: {result['emails_failed']}")
            print(f"   - Ya confirmados: {result['already_acknowledged']}")
            print(f"   - Trabajadores inv√°lidos: {result['invalid_workers']}")
            
            if result['details']:
                print("\nüìù Detalles:")
                for detail in result['details'][:5]:  # Mostrar solo los primeros 5
                    print(f"   - {detail.get('worker_name', 'N/A')}: {detail['status']} - {detail['message']}")
            
            return result
        else:
            print(f"‚ùå Error enviando notificaciones: {response.status_code} - {response.text}")
            return {}
    
    def suppress_notifications(self, worker_ids: list, notification_type: str = None, reason: str = "Prueba administrativa") -> Dict[str, Any]:
        """Suprimir notificaciones para trabajadores espec√≠ficos"""
        print(f"\nüö´ Suprimiendo notificaciones para {len(worker_ids)} trabajadores...")
        
        data = {
            "worker_ids": worker_ids,
            "reason": reason
        }
        
        if notification_type:
            data["notification_type"] = notification_type
        
        response = requests.post(
            f"{self.base_url}/admin/notifications/suppress-notifications",
            headers=self.headers,
            json=data
        )
        
        if response.status_code == 200:
            result = response.json()
            print("‚úÖ Resultado de la supresi√≥n:")
            print(f"   - Total solicitados: {result['total_requested']}")
            print(f"   - Supresiones creadas: {result['suppressions_created']}")
            print(f"   - Ya suprimidas: {result['already_suppressed']}")
            
            return result
        else:
            print(f"‚ùå Error suprimiendo notificaciones: {response.status_code} - {response.text}")
            return {}
    
    def get_acknowledgments(self, limit: int = 10) -> list:
        """Obtener confirmaciones de notificaciones"""
        print(f"\n‚úÖ Obteniendo confirmaciones (l√≠mite: {limit})...")
        
        response = requests.get(
            f"{self.base_url}/admin/notifications/acknowledgments",
            headers=self.headers,
            params={"limit": limit}
        )
        
        if response.status_code == 200:
            data = response.json()
            print(f"‚úÖ Se encontraron {len(data)} confirmaciones")
            
            for ack in data[:3]:  # Mostrar solo las primeras 3
                print(f"   - {ack['worker_name']}: {ack['notification_type']} el {ack['acknowledged_at'][:10]}")
            
            return data
        else:
            print(f"‚ùå Error obteniendo confirmaciones: {response.status_code} - {response.text}")
            return []
    
    def run_demo(self):
        """Ejecutar demostraci√≥n completa"""
        print("üöÄ Iniciando demostraci√≥n de administraci√≥n de notificaciones")
        print("=" * 60)
        
        # 1. Autenticar
        if not self.authenticate():
            return
        
        # 2. Obtener estad√≠sticas
        stats = self.get_statistics()
        
        # 3. Obtener lista de notificaciones
        notifications = self.get_exam_notifications(limit=5)
        
        if notifications:
            # 4. Obtener trabajadores con ex√°menes vencidos o pr√≥ximos a vencer
            workers_to_notify = [
                worker["worker_id"] for worker in notifications
                if worker["exam_status"] in ["vencido", "proximo_a_vencer"]
                and worker["worker_email"]  # Solo los que tienen email
            ][:2]  # Limitar a 2 para la demo
            
            if workers_to_notify:
                print(f"\nüéØ Trabajadores seleccionados para demo: {workers_to_notify}")
                
                # 5. Enviar notificaciones de prueba (sin forzar)
                send_result = self.send_notifications(workers_to_notify, "reminder", force=False)
                
                # 6. Suprimir notificaciones para uno de los trabajadores
                if len(workers_to_notify) > 1:
                    suppress_result = self.suppress_notifications([workers_to_notify[0]], reason="Demo de supresi√≥n")
                
                # 7. Intentar enviar nuevamente (deber√≠a ser bloqueado para el suprimido)
                print("\nüîÑ Intentando enviar nuevamente (deber√≠a ser bloqueado para trabajadores suprimidos)...")
                send_result2 = self.send_notifications(workers_to_notify, "reminder", force=False)
            else:
                print("\n‚ö†Ô∏è No se encontraron trabajadores con ex√°menes vencidos o pr√≥ximos que tengan email")
        
        # 8. Obtener confirmaciones
        acknowledgments = self.get_acknowledgments()
        
        print("\n" + "=" * 60)
        print("‚úÖ Demostraci√≥n completada exitosamente")
        print("\nüìñ Funcionalidades disponibles:")
        print("   - Consultar estado de notificaciones por trabajador")
        print("   - Enviar notificaciones manuales (con control de duplicados)")
        print("   - Suprimir notificaciones para evitar spam")
        print("   - Ver estad√≠sticas generales")
        print("   - Consultar historial de confirmaciones")
        print("   - Eliminar confirmaciones para reactivar notificaciones")


def main():
    """Funci√≥n principal"""
    print("üîß Script de prueba para Administraci√≥n de Notificaciones SST")
    print(f"üìÖ Fecha: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"üåê URL Base: {BASE_URL}")
    print(f"üë§ Usuario: {ADMIN_EMAIL}")
    print()
    
    # Verificar conectividad
    try:
        response = requests.get(f"{BASE_URL}/health")
        if response.status_code == 200:
            print("‚úÖ Servidor disponible")
        else:
            print(f"‚ö†Ô∏è Servidor responde con c√≥digo: {response.status_code}")
    except requests.exceptions.ConnectionError:
        print(f"‚ùå No se puede conectar al servidor en {BASE_URL}")
        print("   Aseg√∫rate de que el servidor est√© ejecut√°ndose")
        return
    
    # Ejecutar demo
    test = AdminNotificationsTest()
    test.run_demo()


if __name__ == "__main__":
    main()