# =============================================================================
# FILTRO FAIL2BAN PARA AUTENTICACIÓN POSTGRESQL
# =============================================================================

[Definition]
# Detectar intentos de autenticación fallidos
# Formato: 2025-10-14 03:35:25.134 UTC [67920] FATAL:  password authentication failed for user "postgres"
failregex = ^.*UTC \[\d+\] FATAL:\s+password authentication failed for user.*$
            ^.*UTC \[\d+\] FATAL:\s+authentication failed for user.*$
            ^.*UTC \[\d+\] FATAL:\s+no pg_hba\.conf entry for.*$
            ^.*UTC \[\d+\] DETAIL:\s+Role ".*" does not exist.*$
            ^.*UTC \[\d+\] FATAL:\s+role ".*" does not exist.*$

# Detectar conexiones con información de cliente (formato extendido)
            ^.*\[.*\]: \[.*\] user=.*,db=.*,app=.*,client=<HOST>.*FATAL:.*authentication failed for user.*$
            ^.*\[.*\]: \[.*\] user=.*,db=.*,app=.*,client=<HOST>.*FATAL:.*password authentication failed for user.*$
            ^.*\[.*\]: \[.*\] user=.*,db=.*,app=.*,client=<HOST>.*FATAL:.*no pg_hba.conf entry for.*$

# Ignorar conexiones locales y de Docker
ignoreregex = client=127\.0\.0\.1
              client=172\.20\..*
              client=172\.17\..*
              client=::1